---
- name: Import the playbook which builds the hosts.yaml file
  ansible.builtin.import_playbook: inventory_playbook.yaml

- name: Perform the initial setup of the Debian webserver(s)
  hosts: debian

  tasks:
    - name: Secure SSH access to the host via the firewall
      block:
        - name: Add rule allowing SSH access only from <bastion>
          community.general.ufw:
            name: OpenSSH
            from_ip: "{{ hostvars.bastion.ansible_host_ipaddr }}"
            rule: allow

        - name: Remove default rule allowing SSH access from <any>
          community.general.ufw:
            from_ip: any
            to_port: 22
            proto: tcp
            rule: allow
            delete: true

    - name: Upgrade installed packages and install Nginx
      block:
        - name: Update the packages list
          ansible.builtin.apt:
            update_cache: true

        - name: Upgrade the installed packages
          ansible.builtin.apt:
            upgrade: safe

        - name: Install Nginx
          ansible.builtin.apt:
            pkg: nginx
            state: present

    - name: Set up the webserver and serve the website
      block:
        - name: Overwrite the default Nginx configuration
          ansible.builtin.copy:
            src: files/nginx.conf
            dest: /etc/nginx/nginx.conf
            backup: true
            validate: /usr/sbin/nginx -t -c %s

        - name: Create the webroot referenced by the conf
          ansible.builtin.file:
            path: /srv/www/html/rtsa_current
            state: directory

        - name: Copy over the website's files
          ansible.builtin.copy:
            src: ../../website/live/rtsa_current/
            dest: /srv/www/html/rtsa_current/

        - name: Add firewall rules allowing HTTP/HTTPS traffic from <any>
          community.general.ufw:
            name: Nginx Full
            from_ip: 0.0.0.0/0
            rule: allow

                #TODO: provide a custom sshd_config variant for Linux distros

              # - name: Configure sshd explicitly
              #   block:
              #     - name: Copy sshd_config over to the host and validate its syntax
              #       ansible.builtin.copy:
              #         src: files/sshd_config
              #         dest: /etc/ssh/sshd_config
              #         backup: true
              #         validate: /usr/sbin/sshd -t -f %s

              #     - name: Enable the new configuration
              #       ansible.builtin.service:
              #         name: sshd
              #         state: reloaded
...
