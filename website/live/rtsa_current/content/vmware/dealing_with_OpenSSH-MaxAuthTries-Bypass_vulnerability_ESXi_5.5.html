<!DOCTYPE html>

<html lang="en">
  <head>
    <link rel="stylesheet" type="text/css" href="/css/style.css" />
    <link rel="stylesheet" type="text/css" href="/css/normalize.css" />
    <link rel="stylesheet" type="text/css" href="/css/markdown.css" />
    <title>RTSA - on the road to becoming a sysadmin</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="One man's attempt to impress complete strangers. On the Internet! Hopefully it'll work." />
  </head>

  <body id="content">
    <header>
      <h3>Dealing with the 'OpenSSH MaxAuthTries Bypass' vulnerability in ESXi 5.5</h3>
      <p>System: VMware ESXi 5.5</p>
      <p id="updated">- last updated on <time datetime="2018-09-10">10.09.2018</time> -</p>
    </header>

    <main class="md">
      <p>
        <strong>About:</strong> The purpose of this document is to present a functional workaround in resolving the
        <a href="http://cve.circl.lu/cve/CVE-2015-5600">OpenSSH MaxAuthTries Bypass/CVE-2015-5600</a> vulnerability in
        ESXi 5.5, since the vendor is unlikely to release a fix in the near future (note that these lines were written
        about 2 years back), since it consists of upgrading OpenSSH to version 7.0 (according to the package's own
        <a href="http://www.openssh.com/txt/release-7.0">release notes</a>), but the software packages that are bundled
        with an ESXi release tend to be pretty static - in this case, ESXi 5.5 U3c (the version that was current at the
        time of this having been written initially) contains version 5.6p1 of OpenSSH.
      </p>

      <p>
        <strong>Workaround:</strong> The fix consists of a modification that needs to be done to the SSH daemon's
        configuration file, the <code>/etc/ssh/sshd_config</code>, namely of disabling OpenSSH's modern
        keyboard-interactive authentication method, which allows the use of various types of authentication methods that
        utilize a keyboard as a means of proving identity, such as one-time passwords or a PIN that is generated based
        on a server challenge, and instead enabling the legacy password method, which only accepts a static
        'username/password' pair for the same purpose. Of course, if you are using the publickey authentication method
        then the point is moot and you are better off disabling the keyboard/password authentication altogether.
      </p>

      <p><strong>Working instructions:</strong></p>
      <ul>
        <li>
          <p>
            verify the current login method by running <code>ssh -v ESXi_hostname/IP_address</code> from a *nix machine
            that has network access to it, such as the vCSA you should see the below line in the output, which confirms
            the vulnerability:
          </p>
        </li>
      </ul>
      <blockquote>
        <p>debug1: Authentications that can continue: publickey,keyboard-interactive</p>
      </blockquote>
      <ul>
        <li>
          <p>
            login to the ESXi host via SSH (preferably not via the above session, as it will keep printing debug
            information)
          </p>
        </li>
        <li>
          <p>run <code>vi /etc/ssh/sshd_config</code></p>
        </li>
        <li>
          <p>once the file is open in Vi, locate the <code>UsePAM yes</code> line and enter the following below it:</p>
          <code>ChallengeResponseAuthentication no</code><br />
          <code>PasswordAuthentication yes</code>
          <ul>
            <p>
              <li>
                check out this <a href="http://www.lagmonster.org/docs/vi.html" target="_blank">Vi 'cheat sheet'</a> for
                help in using the editor
              </li>
              <li>
                the <code>PasswordAuthentication</code> directive should already be there, so simply replace the
                <code>no</code> with a <code>yes</code>
              </li>
            </p>
          </ul>
        </li>
        <li>
          <p>
            save the modifications and confirm them by running <code>less /etc/ssh/sshd_config</code> (or by grepping
            for them)
          </p>
        </li>
        <li>
          <p>restart the SSH daemon by running <code>/etc/init.d/SSH restart</code></p>
        </li>
        <li>
          <p>
            verify the workaround by re-running the <code>ssh -v ESXi_hostname/IP_address</code> command from the
            external system and confirming that the previous output line has now become the one below:
          </p>
        </li>
      </ul>
      <blockquote><p>debug1: Authentications that can continue: publickey,password</p></blockquote>

      <p>
        For the sake of having a reference, below you will find two examples of the sshd_config file, one in its vanilla
        state (should have been previously untouched), and one modified as per the instructions found here:
      </p>
      <p>
        <details>
          <summary>the vanilla 'sshd_config'</summary>
          <pre><code># running from inetd
# Port 2200
Protocol 2
HostKey /etc/ssh/ssh_host_rsa_key
HostKey /etc/ssh/ssh_host_dsa_key

UsePrivilegeSeparation no

SyslogFacility auth
LogLevel info

PermitRootLogin yes

PrintMotd yes
PrintLastLog no

TCPKeepAlive yes

X11Forwarding no

Ciphers aes128-ctr,aes192-ctr,aes256-ctr,3des-cbc

MACs hmac-sha1,hmac-sha1-96

UsePAM yes
# only use PAM challenge-response (keyboard-interactive)
PasswordAuthentication no

Banner /etc/issue

Subsystem sftp /usr/lib/vmware/openssh/bin/sftp-server -f LOCAL5 -l INFO

AuthorizedKeysFile /etc/ssh/keys-%u/authorized_keys

# Timeout value of 10 mins. The default value of ClientAliveCountMax is 3. 
# Hence, we get a  3 * 200 = 600 seconds timeout if the client has been
# unresponsive.
ClientAliveInterval 200

# sshd(8) will refuse connection attempts with a probability of &quot;rate/100&quot;
# (30%) if there are currently &quot;start&quot; (10) unauthenticated connections.  The
# probability increases linearly and all connection attempts are refused if the
# number of unauthenticated connections reaches &quot;full&quot; (100)
MaxStartups 10:30:100</code></pre>
        </details>
      </p>
      <p>
        <details>
          <summary>the modified 'sshd_config'</summary>
          <pre><code># running from inetd
# Port 2200
Protocol 2
HostKey /etc/ssh/ssh_host_rsa_key
HostKey /etc/ssh/ssh_host_dsa_key

UsePrivilegeSeparation no

SyslogFacility auth
LogLevel info

PermitRootLogin yes

PrintMotd yes
PrintLastLog no

TCPKeepAlive yes

X11Forwarding no

Ciphers aes128-ctr,aes192-ctr,aes256-ctr,3des-cbc

MACs hmac-sha1,hmac-sha1-96

UsePAM yes
# only use PAM challenge-response (keyboard-interactive) -- this has been changed, see below

###An attempt to work around the 'OpenSSH MaxAuthTries Bypass' vulnerability -- 19.05.2016 -- IT
## will be implemented by doing the following:
# 1. explicitly entering the 'ChallengeResponseAuthentication' directive and setting it to 'no' (OpenSSH implicitly defaults it to 'yes')
# 2. modifying the 'PasswordAuthentication' directive, by setting it to 'yes' (normally comes defined as 'no')
ChallengeResponseAuthentication no
PasswordAuthentication yes
### end of workaround - to revert, remove everything in this paragraph (quotes included, as they will no longer serve a purpose), with the exception of 'PasswordAuthentication', which should be changed to 'no'

Banner /etc/issue

Subsystem sftp /usr/lib/vmware/openssh/bin/sftp-server -f LOCAL5 -l INFO

AuthorizedKeysFile /etc/ssh/keys-%u/authorized_keys

# Timeout value of 10 mins. The default value of ClientAliveCountMax is 3. 
# Hence, we get a  3 * 200 = 600 seconds timeout if the client has been
# unresponsive.
ClientAliveInterval 200

# sshd(8) will refuse connection attempts with a probability of &quot;rate/100&quot;
# (30%) if there are currently &quot;start&quot; (10) unauthenticated connections.  The
# probability increases linearly and all connection attempts are refused if the
# number of unauthenticated connections reaches &quot;full&quot; (100)
MaxStartups 10:30:100

#Disable the (enabled by default) UseDNS directive, as it serves no purpose (in our particular infrastructure) and only serves to delay the SSH login to the host - 13.04.2016 - IT
UseDNS no</code></pre>
        </details>
      </p>
    </main>

    <footer>
      <hr />
      <nav>
        <ul>
          <li><a href="/">Home</a></li>
          <li><a href="/about.html">About</a></li>
          <li><a href="/contact.html">Contact</a></li>
        </ul>
      </nav>
    </footer>
  </body>
</html>
